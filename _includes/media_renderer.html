{% comment %}
  Media renderer with conditional video sizing and 3-col non-video layout
{% endcomment %}

{% if include.project.media_list %}
  {% assign video_extensions = "mp4,webm" | split: "," %}
  {% assign videos = "" | split: "," %}
  {% assign non_videos = "" | split: "," %}
  {% assign chunk_size = 3 %}

  {% for media_url in include.project.media_list %}
    {% assign media_url = media_url | strip %}
    {% assign media_lc = media_url | downcase %}
    {% assign ext = media_lc | split: "." | last | split: "?" | first %}

    {% if video_extensions contains ext %}
      {% assign videos = videos | push: media_url %}
    {% else %}
      {% assign non_videos = non_videos | push: media_url %}
    {% endif %}
  {% endfor %}

  {% comment %}
    Video container classes depend on number of videos
  {% endcomment %}
  {% assign video_container_class = "video-row single-video" %}
  {% if videos.size > 1 %}
    {% assign video_container_class = "video-row multiple-videos" %}
  {% endif %}

  {% for video in videos %}
    <div class="media-container {{ video_container_class }}">
      <video autoplay loop muted playsinline class="video-item">
        <source src="{{ video }}" type="video/{{ video | split: '.' | last | split: '?' | first }}">
        Your browser does not support the video tag.
      </video>
    </div>
  {% endfor %}

  {% comment %} Non-video media in rows of 3 {% endcomment %}
  {% for media in non_videos %}
    {% assign index0 = forloop.index0 %}
    {% assign is_row_start = index0 modulo chunk_size == 0 %}
    {% assign is_row_end = index0 modulo chunk_size == chunk_size - 1 or forloop.last %}

    {% if is_row_start %}
      <div class="media-container non-video-row">
    {% endif %}

    {% assign media_lc = media | downcase %}
    {% assign is_http = media_lc contains "http://" or media_lc contains "https://" %}
    {% assign is_youtube = false %}
    {% if is_http and (media_lc contains "youtube.com/watch?v=" or media_lc contains "youtube.com/embed/") %}
      {% assign is_youtube = true %}
    {% endif %}

    {% if is_youtube %}
      {% assign youtube_id = "" %}
      {% if media_lc contains "youtube.com/embed/" %}
        {% assign youtube_id = media_lc | split: "/embed/" | last | split: "?" | first %}
      {% elsif media_lc contains "youtube.com/watch?v=" %}
        {% assign youtube_id = media_lc | split: "watch?v=" | last | split: "&" | first %}
      {% endif %}
      <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" frameborder="0" allowfullscreen
              class="non-video-item" style="aspect-ratio: 16/9; border-radius: 8px;">
      </iframe>
    {% else %}
      <img src="{{ media }}" alt="{{ include.project.title }} media" class="non-video-item" />
    {% endif %}

    {% if is_row_end %}
      </div>
    {% endif %}
  {% endfor %}

{% elsif include.project.media %}
  {% assign media_url = include.project.media | strip %}
  {% assign media_lc = media_url | downcase %}
  {% assign ext = media_lc | split: "." | last | split: "?" | first %}
  {% assign is_http = media_lc contains "http://" or media_lc contains "https://" %}
  {% assign is_youtube = false %}
  {% if is_http and (media_lc contains "youtube.com/watch?v=" or media_lc contains "youtube.com/embed/") %}
    {% assign is_youtube = true %}
  {% endif %}

  <div class="media-container video-row single-video">
    {% if is_youtube %}
      {% assign youtube_id = "" %}
      {% if media_lc contains "youtube.com/embed/" %}
        {% assign youtube_id = media_lc | split: "/embed/" | last | split: "?" | first %}
      {% elsif media_lc contains "youtube.com/watch?v=" %}
        {% assign youtube_id = media_lc | split: "watch?v=" | last | split: "&" | first %}
      {% endif %}
      <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" frameborder="0" allowfullscreen
              style="width: 100%; aspect-ratio: 16/9; border-radius: 8px;"></iframe>
    {% elsif ext == "mp4" or ext == "webm" %}
      <video autoplay loop muted playsinline class="video-item">
        <source src="{{ media_url }}" type="video/{{ ext }}">
        Your browser does not support the video tag.
      </video>
    {% else %}
      <img src="{{ media_url }}" alt="{{ include.project.title }} media" style="width: 100%; border-radius: 8px;" />
    {% endif %}
  </div>
{% endif %}
