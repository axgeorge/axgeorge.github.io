{{ content }}

{% comment %}
  media_renderer.html (This will be your new include file)
  This file will contain the logic for rendering various media types.
  It expects 'project' and 'media_url' (if a single media item)
  or 'project.media_list' (for multiple media items) to be passed.
{% endcomment %}

{% if include.project.media_list %}
  {% assign video_extensions = ".mp4,.webm" | split: "," %}
  {% assign chunk_size = 3 %}
  {% assign non_videos = "" | split: "," %}
  {% assign videos = "" | split: "," %}

  {% for media_url in include.project.media_list %}
    {% assign media_lc = media_url | downcase %}
    {% assign is_video = false %}
    {% for ext in video_extensions %}
      {% if media_lc | slice: -ext.size, ext.size == ext %} {# THIS IS THE CHANGE #}
        {% assign is_video = true %}
      {% endif %}
    {% endfor %}
    {% if is_video %}
      {% assign videos = videos | push: media_url %}
    {% else %}
      {% assign non_videos = non_videos | push: media_url %}
    {% endif %}
  {% endfor %}

  {# Render videos one per row #}
  {% for video in videos %}
    <div class="media-container" style="display: flex; flex-direction: column;">
      <video autoplay loop muted playsinline style="width: 100%; border-radius: 8px;">
        <source src="{{ video }}" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>
  {% endfor %}

  {# Render non-videos in groups of 3 #}
  {% assign index = 0 %}
  {% assign total = non_videos | size %}
  {% for media in non_videos %}
    {% if forloop.index0 modulo chunk_size == 0 %}
      <div class="media-container" style="display: flex; gap: 1em; flex-wrap: wrap;">
    {% endif %}

    {% assign media_lc = media | downcase %}
    {% if media_lc contains "youtube.com" or media_lc contains "youtu.be" %}
      <iframe src="{{ media }}" frameborder="0" allowfullscreen style="flex: 1 1 30%; max-width: 30%; border-radius: 8px;"></iframe>
    {% elsif media_lc contains ".jpg" or media_lc contains ".jpeg" or media_lc contains ".png" or media_lc contains ".gif" %}
      <img src="{{ media }}" alt="{{ include.project.title }} media" style="flex: 1 1 30%; max-width: 30%; border-radius: 8px;" />
    {% else %}
      <img src="{{ media }}" alt="{{ include.project.title }} media" style="flex: 1 1 30%; max-width: 30%; border-radius: 8px;" />
    {% endif %}

    {% assign index = index | plus: 1 %}
    {% assign remainder = index modulo chunk_size %}
    {% if remainder == 0 or forloop.last %}
      </div>
    {% endif %}
  {% endfor %}
{% elsif include.project.media %} {# Handles single media if media_list is not present #}
  {% assign media_url = include.project.media %}
  {% assign media_lc = media_url | downcase %}
  <div class="media-container" style="display: flex; flex-direction: column;">
    {% if media_lc contains "youtube.com" or media_lc contains "youtu.be" %}
      <iframe src="{{ media_url }}" frameborder="0" allowfullscreen style="width: 100%; border-radius: 8px;"></iframe>
    {% elsif media_lc contains ".mp4" or media_lc contains ".webm" %}
      <video autoplay loop muted playsinline style="width: 100%; border-radius: 8px;">
        <source src="{{ media_url }}" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    {% else %}
      <img src="{{ media_url }}" alt="{{ include.project.title }} media" style="width: 100%; border-radius: 8px;" />
    {% endif %}
  </div>
{% endif %}